---

- name: Install a DNS server
  apt:
    name: bind9
    state: present

- name: Build the reverse IP address (works only for IPv4)
  when: bind.reverse_ip == "auto"
  tags: facts
  set_fact:
    ip_regex: '([0-9]+)\.([0-9]+)\.([0-9]+)\.([0-9]+)'

- name: Build the reverse IP address (works only for IPv4)
  when: bind.reverse_ip == "auto"
  tags: facts
  set_fact:
    reverse_ip: '{{ external_ip | regex_replace(ip_regex, "\3.\2.\1") }}'

- name: Build the reverse IP address
  when: bind.reverse_ip == "auto"
  tags: facts
  set_fact:
    reverse_ip: bind.reverse_ip

- name: Copy the configuration template
  vars:
    serial: "{{ lookup('pipe', 'date +%s') }}"
  template:
    src: '{{ file.src }}'
    dest: '{{ file.dest }}'
  with_items:
    - src: forward-head
      dest: '/etc/homebox/dns-entries.d/00-head.bind'
    - src: named.conf.options
      dest: '/etc/bind/named.conf.options'
    - src: named.conf.local
      dest: '/etc/bind/named.conf.local'
    - src: reverse-domain
      dest: '/etc/bind/reverse.{{ network.domain }}'
  loop_control:
    loop_var: file

- name: Build the final bind configuration
  assemble:
    src: '/etc/homebox/dns-entries.d/'
    dest: '/etc/bind/forward.{{ network.domain }}'
    delimiter: '\n'
    regexp: '^.*\.bind$'

- name: Create the folder for the keys
  tags: encryption
  file:
    path: '{{ path }}'
    state: directory
    mode: '0750'
    owner: root
    group: bind
  with_items:
    - /etc/bind/keys
    - /etc/bind/keys/tests
  loop_control:
    loop_var: path

- name: Generate the main key
  tags: encryption
  register: main_key_facts
  shell: >-
    dnssec-keygen -q -a {{ bind.dnssec.algo }} -b 1024 {{ network.domain }}
  args:
    chdir: /etc/bind/keys

- name: Set the permissions on the key file generated
  file:
    path: '/etc/bind/keys/{{ main_key_facts.stdout }}.private'
    group: bind
    mode: g+r

- name: Generate the second key (key signing key)
  register: ksk_facts
  tags: encryption
  shell: >-
    dnssec-keygen -q -a {{ bind.dnssec.algo }} -f KSK -b 2048 {{ network.domain }}
  args:
    chdir: /etc/bind/keys

- name: Copy the KSK for testing
  file:
    src: '/etc/bind/keys/{{ ksk_facts.stdout }}.key'
    dest: /etc/bind/keys/tests/ksk.key
    state: link

- name: Create the testing key
  shell: >-
    cat /etc/bind/keys/tests/ksk.key
    | sed '/^;/d'
    | sed 's/IN DNSKEY 257 3 8 /257 3 8 "/'
    | sed 's/^/trusted-keys { /'
    | sed 's/$/"; };/'
    > /etc/bind/keys/tests/testing.key
  args:
    creates: /etc/bind/keys/tests/testing.key

- name: Set the permissions on the KSK file generated
  file:
    path: '/etc/bind/keys/{{ ksk_facts.stdout }}.private'
    group: bind
    mode: g+r

- name: Allow queries to the DNS server from outside
  ufw:
    from_ip: any
    to_ip: any
    proto: udp
    to_port: 53
    comment: 'Allow DNS queries from outside'
    rule: allow

- name: Link DNS entries in /var/cache/bin
  file:
    src: '/etc/bind/{{ file }}'
    dest: '/var/cache/bind/{{ file }}'
    state: link
  with_items:
    - 'forward.{{ network.domain }}'
    - 'reverse.{{ network.domain }}'
  loop_control:
    loop_var: file

- name: Restart bind
  service:
    name: bind9
    state: restarted
