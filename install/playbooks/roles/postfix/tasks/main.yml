---

# Install postfix packages
- name: Install postfix packages
  tags: postfix
  notify: Restart postfix
  apt:
    name: "{{ pkg }}"
    state: installed
  with_items:
    - postfix
    - postfix-cdb
    - postfix-pcre
    - postfix-ldap
    - sasl2-bin
  loop_control:
    loop_var: pkg

################################################################################
# At this point, the certificates should have been created already #############
# in order to have SSL and TLS encryption activated.                           #
- name: Allow postfix to access the certificate directories
  tags: postfix,ssl
  notify: Restart postfix
  when: system.ssl == 'letsencrypt'
  vars:
    details:
      - [ /etc/letsencrypt/archive, /etc/letsencrypt/live ]
      - [ postfix ]
  acl:
    path: '{{ item[0] }}'
    entity: '{{ item[1] }}'
    etype: user
    permissions: rx
    state: present
  with_nested: '{{ details }}'

#                                                                              #
# End of TLS / SSL Configuration ###############################################

- name: Ensure the imap server FQDN resolves to localhost
  tags: postfix
  lineinfile:
    path: /etc/hosts
    line: '127.0.0.1    {{ ldap.hostname }}'
    
- name: Install postfix packages for local administration
  tags: postfix
  notify: Restart postfix
  when: options.local_admin == true
  apt:
    name: "{{ pkg }}"
    state: installed
  with_items:
    - pfqueue
    - bsd-mailx
  loop_control:
    loop_var: pkg
    
- name: Copy configuration template
  tags: postfix
  notify: Restart postfix
  template:
    src: "{{ file }}"
    dest: "/etc/postfix/{{ file }}"
  with_items:
    - main.cf
    - ldap-aliases.cf
  loop_control:
    loop_var: file

- name: Ensure the SMTP server FQDN resolves to localhost
  tags: postfix
  lineinfile:
    path: /etc/hosts
    line: '127.0.0.1    {{ network.smtp }}'
    
- name: Configure the firewall for default access
  tags: security
  ufw:
    rule: allow
    proto: tcp
    src: any
    port: '{{ rule.port }}'
    comment: '{{ rule.comment }}'
  with_items:
    - comment: Allow basic SMTP
      port: 25
    - comment: Allow encrypted SMTP
      port: 465
    - comment: Allow submission
      port: 587
  loop_control:
    loop_var: rule
