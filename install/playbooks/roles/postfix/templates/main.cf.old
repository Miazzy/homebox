# See /usr/share/postfix/main.cf.dist for a commented, more complete version

# General parameters
# compatibility_level = 3                       # For postfix 3
smtpd_banner = $myhostname ESMTP $mail_name   # Default SMTP banner 
message_size_limit = 67108864                 # maximum message size
delay_warning_time = 1h                       # Generate "delayed mail" warnings
append_dot_mydomain = no                      # appending .domain is the MUA's job.
#queue_directory = /var/mail                   # spool directory
disable_vrfy_command = yes                    # Do not authorise the vrfy SMTP command
#smtputf8_enable = yes                         # Allow accents in email addresses
mailbox_size_limit = 0
recipient_delimiter = +


# Network parameters
inet_interfaces = all
inet_protocols = ipv4
mynetworks = 127.0.0.0/8                      # Trusted IP addresses

# Domains configuration
masquerade_domains = {{ network.domain }} {{ network.smtp }}

alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases

# Bounce configuration
# notify_classes = resource, software
double_bounce_sender = postmaster@{{ network.domain }}
notify_classes = delay, resource, software
bounce_notice_recipient =  {{ mail.admin.email }}

# TLS parameters
smtpd_tls_cert_file=/etc/letsencrypt/live/{{ certificate.cn }}/cert.pem
smtpd_tls_key_file=/etc/letsencrypt/live/{{ certificate.cn }}/privkey.pem
smtpd_use_tls=yes
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache

smtpd_client_restrictions =
    permit_mynetworks,
    permit_sasl_authenticated
    permit

smtpd_sasl_type = dovecot
smtpd_sasl_path = private/auth
smtpd_sasl_auth_enable = yes


smtpd_relay_restrictions =
    permit_mynetworks
    permit_sasl_authenticated
    reject_unauth_destination

smtpd_recipient_restrictions =
    permit_sasl_authenticated
    permit_mynetworks
    reject_unauth_destination

# Recipient details
local_recipient_maps = proxy:unix:passwd.byname $alias_maps
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
mydestination = {{ network.hostname }}, {{ network.domain }}, localhost.{{ network.domain }}, localhost
relayhost =

# Cleanup headers of sent emails
# smtp_header_checks = pcre:/etc/postfix/headers-check

# Use dovecot to deliver emails
mailbox_command = /usr/lib/dovecot/dovecot-lda -f "$SENDER" -a "$RECIPIENT" -d "$USER"

